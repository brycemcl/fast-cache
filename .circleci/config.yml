version: 2.1

jobs:
  zstd:
    resource_class: 'arm.large'
    # working_directory: /mnt/ramdisk
    parameters:
      speed:
        type: string
      long:
        type: string
      threads:
        type: string
    docker:
      - image: node:18-slim
    environment:
      THREADS: << parameters.threads >>
      LONG: << parameters.long >>
      SPEED: << parameters.speed >>
    steps:
      - run: apt-get update && apt-get install -y git openssh-client
      - checkout
      - restore_cache:
          keys:
            - v1-{{ .Environment.CIRCLE_SHA1 }}
      - run: apt-get install -y tar zstd rclone
      - run: rclone config create cache "google cloud storage" location=us-east1 bucket_policy_only=true env_auth=true
      - run: npm install pnpm -g
      - run: pnpm run start:upload-zstd
      - run: pnpm run start:restore-zstd
  circleci:
    resource_class: 'arm.large'
    # working_directory: /mnt/ramdisk
    docker:
      - image: node:18-slim
    steps:
      - run: npm install pnpm -g
      - run: apt-get update && apt-get install -y git openssh-client
      - checkout
      - run: pnpm install
      - run: pnpm install --ignore-scripts bloater
      # - run: pnpm run start:createData
      - save_cache:
          key: v1-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - node_modules/
      - run: mv node_modules uploads.old
      - restore_cache:
          keys:
            - v1-{{ .Environment.CIRCLE_SHA1 }}

workflows:
  comparison:
    jobs:
      - zstd:
          requires:
            - circleci
          matrix:
            parameters:
              threads:
                - "--threads=4"
                - '--threads=1'
              long:
                - '--long'
              speed:
                # - "--fast=5"
                # - "--fast=4"
                # - "--fast=3"
                # - "--fast=2"
                # - "--fast=1"
                # - "-1"
                - '-2'
                # - "-3"
                # - "-4"
                # - "-5"
      - circleci
